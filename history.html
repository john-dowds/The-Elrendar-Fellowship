<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>The Elrendar Fellowship — Abridged History</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="style.css" rel="stylesheet"/>
<style>
  .history-wrap{
    max-width:1200px; margin:2rem auto; padding:0 1rem; display:grid; gap:1.5rem;
    grid-template-columns: 280px 1fr;
  }
  .sidebar{
    max-height: calc(100vh - 160px);
    overflow-y: auto;
    position: sticky; top: 80px;
    display: flex; flex-direction: column; gap:.5rem;
    background: rgba(0,0,0,.55);
    border: 1px solid rgba(252,229,205,.2);
    border-radius: 12px; padding: .75rem;
  }
  .sidebar h2{ font-size:1.1rem; margin:.25rem .25rem .5rem; color:#fce5cd; }
  .sidebar a{
    display:block; text-decoration:none; padding:.45rem .6rem; border-radius:.5rem;
    border:1px solid rgba(252,229,205,.15); color:#fce5cd;
  }
  .sidebar a:hover{ background: rgba(252,229,205,.08); }
  .scroll-pane{
    height: calc(100vh - 160px);
    overflow: auto;
    padding-right: .5rem;
  }
  .era{ scroll-margin-top: 100px; }
  .era h1{ margin-top:0; font-size:1.8rem; }
  .era h2{ font-size:1.2rem; margin:.25rem 0 .75rem; opacity:.9; }
  .era .text-block{ margin-bottom:1rem; }

  .related-wrap{
    display:flex; align-items:center; gap:.5rem; flex-wrap: wrap;
    margin: .5rem 0 0;
  }
  .related-label{
    opacity:.9; font-size:.95rem;
  }
  .entity-tags{
    display:flex; gap:.5rem; flex-wrap:wrap;
  }
  .entity-tags a{
    text-decoration:none;
    border:1px solid rgba(252,229,205,.35);
    border-radius:.5rem;
    padding:.25rem .55rem;
    color:#fce5cd;
    font-size:.9rem;
    white-space:nowrap;
  }
  .entity-tags a:hover{ background: rgba(252,229,205,.08); }

  @media (max-width: 900px){
    .history-wrap{ grid-template-columns: 1fr; }
    .sidebar{
      max-height: calc(100vh - 160px);
      overflow-y: auto; position: static;
    }
    .scroll-pane{ height:auto; }
  }
  /* Only the Show/Hide Related button */
.related-wrap > .toggle-related-btn {
  appearance: none;
  display: inline-block;
  margin-bottom: 6px !important;
  padding: 4px 10px !important;
  font-size: 0.9rem !important;
  line-height: 1.2 !important;
  color: #fce5cd !important;                       
  background: rgba(0,0,0,0.35) !important;           
  border: 1px solid rgba(252,229,205,0.35) !important;
  border-radius: 10px !important;
  cursor: pointer !important;
  text-decoration: none !important;
}

.related-wrap > .toggle-related-btn:hover {
  background: rgba(252,229,205,0.08) !important;
}

.related-wrap > .toggle-related-btn:focus {
  outline: 2px solid rgba(252,229,205,0.45) !important;
  outline-offset: 2px !important;
}

</style>
</head>
<body>
  <img alt="Elven Sigil" class="sigil-overlay" src="assets/art/crest2.png"/>
  <header class="banner">
    <h1 class="site-title">The Elrendar Fellowship</h1>
  </header>

  <nav class="menu-bar">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle">About ▾</a>
        <ul class="dropdown-menu">
          <li><a href="about.html">At A Glance</a></li>
          <li><a href="conduct.html">Code of Conduct</a></li>
          <li><a href="faq.html">FAQ</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle">Roleplay ▾</a>
        <ul class="dropdown-menu">
          <li><a href="history.html">History</a></li>
          <li><a href="system.html">Rule Book</a></li>
          <li><a href="monsterguide.html">Monster Manual</a></li>
          <li><a href="monsterbuilder.html">Encounter Builder</a></li>
          <li><a href="dm-assist.html">DM Event Assistant</a></li>
        </ul>
      </li>
      <li><a href="members.html">Members</a></li>
      <li><a href="apply.html">Apply</a></li>
    </ul>
  </nav>

  <main class="history-wrap">
    <aside class="sidebar" id="history-sidebar"><h2>Featured Campaigns &amp; History</h2></aside>
    <section class="scroll-pane" id="history-list"></section>
  </main>

  <footer class="site-footer">
    <p>© 2025 The Elrendar Fellowship Guild</p>
    <p>Blizzard Entertainment, Inc. and all respective artists retain all rights to the names, images and other intellectual property featured here of their own creation.</p>
    <p>This site is a social guild landing webpage and is not endorsed or affiliated with Blizzard Entertainment.</p>
  </footer>

  <script>
    (async function () {
      // Load history first
      const histData = await fetch('assets/data/history.json', { cache: 'no-store' })
        .then(r => r.ok ? r.json() : { sections: [] })
        .catch(() => ({ sections: [] }));
  
      const sections = (histData.sections || []).sort((a,b) => (b.order ?? 0) - (a.order ?? 0));
  
      // Sidebar links
      const sidebar = document.getElementById('history-sidebar');
      const list = document.getElementById('history-list');
  
      const linkFrag = document.createDocumentFragment();
      for (const s of sections) {
        const a = document.createElement('a');
        a.href = `#${s.id}`;
        a.textContent = s.title || s.id;
        linkFrag.appendChild(a);
      }
      sidebar.appendChild(linkFrag);
  
      const artFrag = document.createDocumentFragment();
      for (const s of sections) {
        const article = document.createElement('article');
        article.className = 'era';
        article.id = s.id;
  
        const block = document.createElement('div');
        block.className = 'text-block';
  
        const h1 = document.createElement('h1');
        h1.textContent = s.title || '';
  
        const h2 = document.createElement('h2');
        h2.textContent = s.date || '';
  
        const p = document.createElement('p');
        p.innerHTML = s.summary_html || '';
  
        const related = document.createElement('div');
        related.className = 'related-wrap';
        related.dataset.historyId = s.id;
  
        block.appendChild(h1);
        if (s.subtitle) {
          const sub = document.createElement('h2');
          sub.className = 'subtitle';
          sub.textContent = s.subtitle;
          block.appendChild(sub);
        }
        block.appendChild(h2);
        block.appendChild(p);
        block.appendChild(related);
  
        article.appendChild(block);
        artFrag.appendChild(article);
      }
      list.appendChild(artFrag);
  
      /* Deep-link scrolling into the inner scroll container */
      function scrollToHistoryId(id) {
        if (!id) return false;
        const el = document.getElementById(id);
        if (!el) return false;
  
        // Try native so CSS scroll-margin-top on .era can apply
        try {
          el.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
        } catch {}
  
        // Manual alignment fallback (and fine-tune)
        const pane = document.getElementById('history-list');
        if (pane) {
          const elRect   = el.getBoundingClientRect();
          const paneRect = pane.getBoundingClientRect();
          const marginTop = parseFloat(getComputedStyle(el).scrollMarginTop || '0') || 0;
          const delta = elRect.top - paneRect.top + pane.scrollTop - marginTop;
          pane.scrollTo({ top: delta, behavior: 'smooth' });
        }
        return true;
      }
  
      function goToHashTarget() {
        const id = decodeURIComponent((location.hash || '').replace(/^#/, ''));
        if (!id) return;
        // Defer to ensure paint before measuring
        requestAnimationFrame(() => scrollToHistoryId(id));
      }
  
      // Initial deep-link (basic content is in DOM now)
      goToHashTarget();
  
      // Sidebar in-page links should scroll the inner pane, not the window
      if (sidebar) {
        sidebar.addEventListener('click', (e) => {
          const a = e.target.closest('a[href^="#"]');
          if (!a) return;
          const id = decodeURIComponent(a.getAttribute('href').slice(1));
          if (scrollToHistoryId(id)) {
            e.preventDefault();
            history.replaceState(null, '', '#' + id);
          }
        });
      }
  
      // Respond to manual hash changes, too
      window.addEventListener('hashchange', goToHashTarget);
  
      // ----- Data linking for "Related" entity chips -----
      const dataFiles = [
        'assets/data/npcs.json',
        'assets/data/factions.json',
        'assets/data/aberrations.json',
        'assets/data/beasts.json',
        'assets/data/critters.json',
        'assets/data/demons.json',
        'assets/data/dragonkin.json',
        'assets/data/elementals.json',
        'assets/data/giants.json',
        'assets/data/humanoids.json',
        'assets/data/mechanical.json',
        'assets/data/undead.json'
      ];
  
      async function loadJsonSafe(url) {
        try {
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const text = await res.text();
          if (!text.trim()) return { entries: [], categories: [] };
          return JSON.parse(text);
        } catch (e) {
          console.warn('Skipping data file:', url, e);
          return { entries: [], categories: [] };
        }
      }
  
      function* iterEntries(source) {
        if (Array.isArray(source.categories)) {
          for (const c of source.categories) {
            for (const s of (c.subcategories || [])) {
              for (const e of (s.entries || [])) yield e;
            }
          }
        } else {
          for (const e of (source.entries || [])) yield e;
        }
      }
  
      const allSets = await Promise.all(dataFiles.map(loadJsonSafe));
      const byHistoryId = new Map();
  
      for (const set of allSets) {
        for (const e of iterEntries(set)) {
          const links = Array.isArray(e.campaignLinks) ? e.campaignLinks : [];
          for (const hid of links) {
            if (!byHistoryId.has(hid)) byHistoryId.set(hid, []);
            const arr = byHistoryId.get(hid);
            if (!arr.some(x => x.id === e.id)) {
              arr.push({
                id: e.id,
                name: e.name || e.id,
                class: e.class || '',
                category: e.category || '',
                subcategory: e.subcategory || ''
              });
            }
          }
        }
      }
  
      for (const s of sections) {
        const rel = list.querySelector(`.related-wrap[data-history-id="${s.id}"]`);
        if (!rel) continue;
  
        const ents = (byHistoryId.get(s.id) || []).sort((a,b)=>{
          const ka = `${a.category} ${a.subcategory} ${a.name}`.toLowerCase();
          const kb = `${b.category} ${b.subcategory} ${b.name}`.toLowerCase();
          return ka.localeCompare(kb);
        });
  
        if (!ents.length) continue;
  
        const tags = document.createElement('div');
        tags.className = 'entity-tags';
  
        const toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.className = 'toggle-related-btn';
        toggleBtn.textContent = 'Hide Related ▾';
        toggleBtn.setAttribute('aria-expanded', 'true');
        toggleBtn.removeAttribute('style');
  
        toggleBtn.addEventListener('click', () => {
          const hidden = tags.style.display === 'none';
          tags.style.display = hidden ? '' : 'none';
          toggleBtn.textContent = (hidden ? 'Hide' : 'Show') + ' Related ' + (hidden ? '▾' : '▸');
          toggleBtn.setAttribute('aria-expanded', String(hidden));
        });
  
        for (const e of ents) {
          const a = document.createElement('a');
          a.href = `monsterguide.html#${encodeURIComponent(e.id)}`;
          a.title = [e.class, e.category, e.subcategory].filter(Boolean).join(' • ');
          a.textContent = e.name;
          tags.appendChild(a);
        }
  
        rel.appendChild(toggleBtn);
        rel.appendChild(tags);
      }
  
      // Re-run deep-link after Related chips finished rendering (layout changed)
      requestAnimationFrame(() => requestAnimationFrame(goToHashTarget));
  
      // Also re-run once after the full page finishes loading (fonts/images)
      window.addEventListener('load', () => {
        setTimeout(goToHashTarget, 0);
        setTimeout(goToHashTarget, 80);
      });
  
      // And re-run once on the first measurable resize of the inner pane
      let didResizeScroll = false;
      const ro = new ResizeObserver(() => {
        if (didResizeScroll) return;
        didResizeScroll = true;
        goToHashTarget();
        ro.disconnect();
      });
      ro.observe(list);
  
    })().catch(err => {
      console.error('Failed to build history page', err);
      const list = document.getElementById('history-list');
      if (list) list.innerHTML = '<div class="text-block"><p>History entries are unavailable right now.</p></div>';
    });
  </script>
  
</body>
</html>