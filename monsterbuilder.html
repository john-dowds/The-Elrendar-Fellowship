<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monster Builder — The Elrendar Fellowship</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    nav.menu-bar { z-index: 1200 !important; }
    nav.menu-bar .dropdown-menu { z-index: 1300 !important; }
    a, a:visited { color: #fce5cd; }

    .builder-wrap{ max-width:1200px; margin:2rem auto; padding:0 1rem; color:#fce5cd; }
    .controls{
      display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; justify-content:space-between;
      background:rgba(0,0,0,.55); border:1px solid rgba(252,229,205,.2); border-radius:12px; padding:.75rem;
      position:sticky; top:80px; z-index:103; backdrop-filter:blur(2px);
    }
    .controls .left,.controls .right{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .btn{
      background:linear-gradient(#7d5a1a,#3d2a12); color:#fff; border:1px solid #000; border-radius:999px;
      padding:.55rem .9rem; cursor:pointer; font-weight:700; font-size:.95rem;
    }
    .btn:hover{ filter:brightness(1.08); }

    .picker{ display:grid; gap:.5rem; grid-template-columns:repeat(4,minmax(0,1fr)); margin:1rem 0; }
    @media (max-width:900px){ .picker{ grid-template-columns:1fr; } }

    .picker select{
      background:rgba(0,0,0,.35); color:#fce5cd;
      border:1px solid rgba(252,229,205,.25); border-radius:8px; padding:.6rem .7rem; width:100%;
    }

    .muted{ opacity:.85; font-size:.95rem; }

    .tabs{ margin-top:1rem; background:rgba(0,0,0,.55); border:1px solid rgba(252,229,205,.2); border-radius:12px; overflow:hidden; }
    .tab-bar{ display:flex; flex-wrap:wrap; gap:.5rem; padding:.5rem; border-bottom:1px solid rgba(252,229,205,.15); background:rgba(0,0,0,.35); }
    .tab{ display:flex; align-items:center; gap:.4rem; padding:.35rem .6rem; border:1px solid rgba(252,229,205,.25); border-radius:999px; cursor:pointer; background:rgba(0,0,0,.2); }
    .tab.is-active{ background:rgba(252,229,205,.08); }
    .tab .x{ font-weight:900; opacity:.8; cursor:pointer; }
    .tab .x:hover{ opacity:1; }

    .tab-body{ padding:1rem; display:grid; gap:1rem; grid-template-columns:1fr 1fr; }
    @media (max-width:900px){ .tab-body{ grid-template-columns:1fr; } }

    .card{ background:rgba(0,0,0,.4); border:1px solid rgba(252,229,205,.2); border-radius:10px; padding:.9rem; }
    .card h3{ margin:.25rem 0 .5rem; }

    .row-2{ display:grid; gap:.6rem; grid-template-columns:1fr 1fr; }
    @media (max-width:700px){ .row-2{ grid-template-columns:1fr; } }

    .field{ margin:.55rem 0; }
    .field label{ display:block; font-weight:700; margin-bottom:.25rem; }
    .field input,.field textarea{
      width:100%; background:rgba(0,0,0,.35); color:#fce5cd; border:1px solid rgba(252,229,205,.25); border-radius:8px; padding:.6rem .7rem;
    }
    .field input[readonly]{ opacity:.9; background:rgba(0,0,0,.25); }
    .field textarea{ min-height:120px; resize:vertical; }

    .field input::placeholder, .field textarea::placeholder{
      color: rgba(252,229,205,.6);
      opacity: 1;
    }

    .badge{ border:1px solid rgba(252,229,205,.35); border-radius:999px; padding:.15rem .55rem; }

    .picker--traits{
      display:grid; gap:.5rem; grid-template-columns:repeat(2,minmax(0,1fr)); margin:.35rem 0;
    }

    .trait-preview{
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(252,229,205,.25);
      border-radius: 8px;
      padding: .6rem .7rem;
      margin: .35rem 0 .5rem;
    }
    .trait-preview .t-name{ font-weight:700; }
    .trait-preview .t-meta{ opacity:.85; font-size:.9rem; margin-bottom:.25rem; }
  </style>
</head>
<body>
  <header class="banner"><h1 class="site-title">The Elrendar Fellowship</h1></header>

  <nav class="menu-bar">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle">About ▾</a>
        <ul class="dropdown-menu">
          <li><a href="about.html">At A Glance</a></li>
          <li><a href="conduct.html">Code of Conduct</a></li>
          <li><a href="faq.html">FAQ</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle">Roleplay ▾</a>
        <ul class="dropdown-menu">
          <li><a href="monsterguide.html">Monster Manual</a></li>
          <li><a href="history.html">History</a></li>
          <li><a href="system.html">Rule Book</a></li>
          <li><a href="monsterbuilder.html">Encounter Builder</a></li>
        </ul>
      </li>
      <li><a href="members.html">Members</a></li>
      <li><a href="apply.html">Apply</a></li>
    </ul>
  </nav>

  <main class="builder-wrap">
    <div class="controls">
      <div class="left">
        <strong>Monster Builder</strong>
        <span class="badge">Each tab exports into a shared spreadsheet.</span>
      </div>
      <div class="right">
        <button id="addMonster" class="btn">+ Add Monster Tab</button>
        <button id="exportExcel" class="btn">⬇ Export Excel</button>
      </div>
    </div>

    <div class="picker" aria-label="Monster Picker">
      <select id="pickCategory" aria-label="Category"></select>
      <select id="pickSubcategory" aria-label="Subcategory"></select>
      <select id="pickMonster" aria-label="Monster"></select>
      <select id="pickLevel" aria-label="Level"></select>
    </div>
    <div class="muted">Choose a monster (and Level) above, then use <em>+ Add Monster Tab</em>. Clone or reload tabs as needed; export when done. All data is pulled from the Monster Manual.</div>

    <section class="tabs">
      <div id="tabBar" class="tab-bar"></div>
      <div id="tabPanel"></div>
    </section>
  </main>

  <footer class="site-footer">
    <p>© 2025 The Elrendar Fellowship Guild</p>
    <p>Blizzard Entertainment, Inc. and all respective artists retain all rights to the names, images and other intellectual property featured here of their own creation.</p>
    <p>This site is a social guild landing webpage and is not endorsed or affiliated with Blizzard Entertainment.</p>
  </footer>

  <script>
    const dataFiles = [
      'assets/data/aberrations.json',
      'assets/data/beasts.json',
      'assets/data/critters.json',
      'assets/data/demons.json',
      'assets/data/dragonkin.json',
      'assets/data/elementals.json',
      'assets/data/giants.json',
      'assets/data/humanoids.json',
      'assets/data/mechanical.json',
      'assets/data/undead.json',
      'assets/data/npcs.json'
    ];

    /* Traits loader & grouping */
    const TRAIT_THEMES = ["damage","aoe","roots","healing","buffs","debuffs","translocation","utility"];
    let traitsCatalog = [];
    let traitsByTheme = new Map();

    async function loadTraitsCatalog() {
      try {
        const res = await fetch('assets/data/traits.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const tdata = await res.json();
        const entries = Array.isArray(tdata.entries) ? tdata.entries : [];
        traitsCatalog = entries;

        traitsByTheme.clear();
        for (const th of TRAIT_THEMES) traitsByTheme.set(th, []);
        for (const t of entries) {
          const theme = (t.theme || '').toLowerCase();
          if (!traitsByTheme.has(theme)) traitsByTheme.set(theme, []);
          traitsByTheme.get(theme).push(t);
        }
        for (const [th, list] of traitsByTheme) {
          list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
        }
      } catch (e) {
        console.warn('Failed to load traits.json; Theme/Ability picker disabled.', e);
      }
    }

    async function loadJsonSafe(url) {
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        if (!text.trim()) return { entries: [], categories: [] };
        return JSON.parse(text);
      } catch (e) {
        console.warn('Skipping data file:', url, e);
        return { entries: [], categories: [] };
      }
    }

    function normalize(source){
      if (Array.isArray(source.categories)) return JSON.parse(JSON.stringify(source.categories));

      const byCategory = new Map();

      function addPlacement(entry, cat, sub) {
        const category = cat || 'Other';
        const subcategory = sub || 'Misc';
        if (!byCategory.has(category)) byCategory.set(category, new Map());
        const subs = byCategory.get(category);
        if (!subs.has(subcategory)) subs.set(subcategory, []);
        const list = subs.get(subcategory);
        if (!list.some(e => e.id === entry.id)) {
          list.push({ ...entry, category: category, subcategory: subcategory });
        }
      }

      for (const e of (source.entries || [])) {
        addPlacement(e, e.category, e.subcategory);
        if (Array.isArray(e.alsoAppearsIn)) {
          for (const p of e.alsoAppearsIn) {
            if (p && (p.category || p.subcategory)) {
              addPlacement(e, p.category, p.subcategory);
            }
          }
        }
      }

      const out = [];
      for (const [category, subs] of byCategory.entries()) {
        const subcategories = [];
        for (const [name, entries] of subs.entries()) {
          subcategories.push({ name, entries });
        }
        subcategories.sort((a, b) => a.name.localeCompare(b.name));
        out.push({ category, subcategories });
      }

      out.sort((a, b) => {
        const pref = (x) => (x.category === 'Humanoids' ? 0 : x.category === 'Beasts' ? 1 : 2);
        const pa = pref(a), pb = pref(b);
        return pa === pb ? a.category.localeCompare(b.category) : pa - pb;
      });

      return out;
    }

    function mergeCategoryBlocks(blocks){
      const acc = [];
      for (const cur of blocks) {
        const ix = acc.findIndex(c=>c.category===cur.category);
        if (ix===-1) acc.push(cur);
        else acc[ix].subcategories.push(...cur.subcategories);
      }
      return acc.map(cat=>{
        const map = new Map();
        for (const s of cat.subcategories) {
          if (!map.has(s.name)) map.set(s.name, []);
          map.get(s.name).push(...(s.entries||[]));
        }
        const subcategories = [...map.entries()].map(([name, entries])=>({name, entries}))
          .sort((a,b)=>a.name.localeCompare(b.name));
        return { category: cat.category, subcategories };
      });
    }

    const LEVELS = { Minion: 0.5, Elite: 1.5, Boss: 3 };

    const catSel   = document.getElementById('pickCategory');
    const subSel   = document.getElementById('pickSubcategory');
    const monSel   = document.getElementById('pickMonster');
    const levelSel = document.getElementById('pickLevel');

    const tabBar   = document.getElementById('tabBar');
    const tabPanel = document.getElementById('tabPanel');

    const addBtn    = document.getElementById('addMonster');
    const exportBtn = document.getElementById('exportExcel');

    let mergedCategories = [];
    let tabs = [];
    let activeId = null;

    (async function init(){
      const allData = await Promise.all(dataFiles.map(loadJsonSafe));
      await loadTraitsCatalog();
      mergedCategories = mergeCategoryBlocks(allData.map(normalize).flat());
      buildPickers();

      buildEmptyTopPickers();
      renderTabs();

      addBtn.addEventListener('click', addTabFromCurrentPicker);
      exportBtn.addEventListener('click', doExport);
    })();

    function buildEmptyTopPickers(){
      levelSel.innerHTML = '';
      const phL = document.createElement('option');
      phL.value = ''; phL.textContent = '— Select Level —'; phL.disabled = true; phL.selected = true;
      levelSel.appendChild(phL);
      ['Minion','Elite','Boss'].forEach(val=>{
        const opt = document.createElement('option'); opt.value = val; opt.textContent = val; levelSel.appendChild(opt);
      });

      catSel.innerHTML = '';
      const phC = document.createElement('option');
      phC.value = ''; phC.textContent = '— Select Category —'; phC.disabled = true; phC.selected = true;
      catSel.appendChild(phC);
      for (const c of mergedCategories) {
        const opt = document.createElement('option'); opt.value = c.category; opt.textContent = c.category; catSel.appendChild(opt);
      }
      subSel.innerHTML = '';
      const phS = document.createElement('option');
      phS.value = ''; phS.textContent = '— Select Subcategory —'; phS.disabled = true; phS.selected = true;
      subSel.appendChild(phS);
      monSel.innerHTML = '';
      const phM = document.createElement('option');
      phM.value = ''; phM.textContent = '— Select Monster —'; phM.disabled = true; phM.selected = true;
      monSel.appendChild(phM);

      catSel.addEventListener('change', syncSubcats);
      subSel.addEventListener('change', syncMonsters);
    }

    function buildPickers(){
  
    }

    function syncSubcats(){
      subSel.innerHTML = '';
      const ph = document.createElement('option');
      ph.value = ''; ph.textContent = '— Select Subcategory —'; ph.disabled = true; ph.selected = true;
      subSel.appendChild(ph);

      monSel.innerHTML = '';
      const phM = document.createElement('option');
      phM.value = ''; phM.textContent = '— Select Monster —'; phM.disabled = true; phM.selected = true;
      monSel.appendChild(phM);

      const cat = mergedCategories.find(c=>c.category===catSel.value);
      if (!cat) return;
      for (const s of (cat.subcategories||[])) {
        const opt = document.createElement('option');
        opt.value = s.name; opt.textContent = s.name;
        subSel.appendChild(opt);
      }
    }

    function syncMonsters(){
      monSel.innerHTML = '';
      const phM = document.createElement('option');
      phM.value = ''; phM.textContent = '— Select Monster —'; phM.disabled = true; phM.selected = true;
      monSel.appendChild(phM);

      const cat = mergedCategories.find(c=>c.category===catSel.value);
      const sub = (cat?.subcategories||[]).find(s=>s.name===subSel.value);
      for (const e of (sub?.entries||[])) {
        const opt = document.createElement('option');
        opt.value = e.id || e.name;
        opt.textContent = e.name || e.id;
        opt.dataset.payload = JSON.stringify(e);
        monSel.appendChild(opt);
      }
    }

    function currentPickerEntry(){
      const opt = monSel.selectedOptions[0];
      return opt && opt.value ? JSON.parse(opt.dataset.payload) : null;
    }

    function displayNameFor(tabData){
      return (tabData.customName && tabData.customName.trim()) || tabData.baseName || 'Monster';
    }

    function addTabFromCurrentPicker(){
      const entry = currentPickerEntry();
      if (!entry) {
        alert('Select Category → Subcategory → Monster → Level before adding a tab.');
        return;
      }
      if (!levelSel.value) {
        alert('Please select a Level.');
        return;
      }
      const id = 'tab_' + Math.random().toString(36).slice(2,8);
      const data = toTabDataFromEntry(entry, levelSel.value);
      const base = displayNameFor(data);
      const title = uniquifyTitle(base);
      tabs.push({ id, title, data });
      activeId = id;
      renderTabs();
    }

    function toTabDataFromEntry(m, level) {
      const mult = { Minion:0.5, Elite:1.5, Boss:3 }[level] ?? 1;
      const baseHpNum = Number(m.hp);
      const hp = Number.isFinite(baseHpNum) ? Math.max(1, Math.round(baseHpNum * mult)) : '';
      const traitsPH = (m.traits||[]).map(t => `${t.name}: ${t.effect}`).join('\n');
      const descPH   = m.description || '';
      return {
        baseName: m.name || '',
        customName: '',
        level: level || '',
        class: m.class || '',
        category: m.category || '',
        subcategory: m.subcategory || '',
        hp,
        traits: '',            
        traitsPH,
        description: '',        
        descriptionPH: descPH,
        image: m.image || '',
        campaignLinks: (m.campaignLinks||[]).join(', '),
        count: 1,
        notes: ''
      };
    }

    function uniquifyTitle(base){
      let n = 1, t = base || 'Monster';
      while (tabs.some(tb => tb.title === t)) { n += 1; t = `${base} (${n})`; }
      return t;
    }

    function renderTabs(){
      tabBar.innerHTML = '';
      for (const t of tabs) {
        const el = document.createElement('div');
        el.className = 'tab' + (t.id===activeId ? ' is-active' : '');
        el.dataset.tabId = t.id;
        el.innerHTML = `
          <span class="t-title">${escapeHtml(t.title)}</span>
          <span data-x="${t.id}" class="x" title="Remove">×</span>
        `;
        el.addEventListener('click', (e)=>{
          if (e.target && e.target.dataset.x) return;
          activeId = t.id; renderTabs();
        });
        el.querySelector('.x').addEventListener('click', ()=> removeTab(t.id));
        tabBar.appendChild(el);
      }

      const active = tabs.find(t=>t.id===activeId);
      tabPanel.innerHTML = active ? tabForm(active) : '<div class="card" style="margin:1rem;">No monsters yet.</div>';
      if (active) wireForm(active);
    }

    function removeTab(id){
      const ix = tabs.findIndex(t=>t.id===id);
      if (ix===-1) return;
      tabs.splice(ix,1);
      activeId = tabs[ix]?.id || tabs[ix-1]?.id || null;
      renderTabs();
    }

    function cloneActive(){
      const src = tabs.find(t=>t.id===activeId);
      if (!src) return;
      const id = 'tab_' + Math.random().toString(36).slice(2,8);
      const data = JSON.parse(JSON.stringify(src.data));
      const base = displayNameFor(data);
      const title = uniquifyTitle(base);
      tabs.push({ id, title, data });
      activeId = id;
      renderTabs();
    }

    function tabForm(tab){
      const d = tab.data;
      return `
        <div class="tab-body">
          <div class="card">
            <h3>Template</h3>

            <div class="row-2">
              <div class="field">
                <label>Base Monster:</label>
                <input data-k="baseName" value="${escapeHtml(d.baseName)}" readonly />
              </div>
              <div class="field">
                <label>Name (Optional):</label>
                <input data-k="customName" value="${escapeHtml(d.customName)}" placeholder="e.g., Rakkor the Red" />
              </div>
            </div>

            <div class="row-2">
              <div class="field">
                <label>Class:</label>
                <input data-k="class" value="${escapeHtml(d.class)}" placeholder="e.g., Zealot Caster" />
              </div>
              <div class="field">
                <label>Level:</label>
                <input data-k="level" value="${escapeHtml(d.level||'')}" placeholder="Minion / Elite / Boss" />
              </div>
            </div>

            <div class="row-2">
              <div class="field">
                <label>Category:</label>
                <input data-k="category" value="${escapeHtml(d.category)}" placeholder="e.g., Humanoids" />
              </div>
              <div class="field">
                <label>Subcategory:</label>
                <input data-k="subcategory" value="${escapeHtml(d.subcategory)}" placeholder="e.g., Kaldorei" />
              </div>
            </div>

            <div class="row-2">
              <div class="field">
                <label>HP:</label>
                <input data-k="hp" value="${escapeHtml(String(d.hp))}" placeholder="e.g., 18" />
              </div>
              <div class="field">
                <label>Count:</label>
                <input data-k="count" type="number" min="1" step="1" value="${Number(d.count)||1}" placeholder="1" />
              </div>
            </div>

            <div class="field">
              <label>Traits (one per line):</label>

              <!-- Theme → Ability picker -->
              <div class="picker picker--traits" aria-label="Trait Picker">
                <div class="field">
                  <label style="font-weight:600;">Theme</label>
                  <select id="traitTheme" aria-label="Trait Theme"></select>
                </div>
                <div class="field">
                  <label style="font-weight:600;">Ability</label>
                  <select id="traitAbility" aria-label="Trait Ability"></select>
                </div>
              </div>

              <!-- Live effect preview -->
              <div id="traitPreview" class="trait-preview" aria-live="polite">
                <div class="t-name">Select a theme and ability</div>
                <div class="t-meta">Preview shows here.</div>
                <div class="t-eff">—</div>
              </div>

              <button type="button" class="btn" id="insertTraitBtn">+ Insert Selected Ability</button>

              <textarea data-k="traits" placeholder="${escapeHtml(d.traitsPH || 'Trait Name: Effect')}"></textarea>
              <div class="muted">Tip: Use the Theme/Ability picker to add a canonical trait, or just type your own on new lines.</div>
            </div>

            <div class="field">
              <label>Description:</label>
              <textarea data-k="description" placeholder="${escapeHtml(d.descriptionPH || '')}"></textarea>
            </div>
          </div>

          <div class="card">
            <h3>Extras</h3>
            <div class="field">
              <label>Image URL</label>
              <input data-k="image" value="${escapeHtml(d.image)}" placeholder="https://..." />
            </div>
            <div class="field">
              <label>Campaign Links (IDs, comma-separated)</label>
              <input data-k="campaignLinks" value="${escapeHtml(d.campaignLinks)}" placeholder="ancients, legion" />
            </div>
            <div class="field">
              <label>Notes (DM only)</label>
              <textarea data-k="notes" placeholder="Private notes for your session...">${escapeHtml(d.notes)}</textarea>
            </div>

            <div class="field" style="display:flex; gap:.5rem; flex-wrap:wrap;">
              <button type="button" class="btn" id="cloneBtn">Clone Tab</button>
              <button type="button" class="btn" id="reloadFromPickerBtn">Reload</button>
            </div>
          </div>
        </div>
      `;
    }

    function setTabTitle(tab, baseTitle, { commit = false } = {}) {
      let title = (baseTitle || 'Monster').trim() || 'Monster';
      if (commit) {
        let suffix = 1, candidate = title;
        while (tabs.some(t => t.id !== tab.id && t.title === candidate)) {
          suffix += 1; candidate = `${title} (${suffix})`;
        }
        title = candidate;
        tab.title = title;
      }
      const node = tabBar.querySelector(`.tab[data-tab-id="${tab.id}"] .t-title`);
      if (node) node.textContent = title;
    }

    function wireForm(tab){
      const panel = tabPanel;
      panel.querySelectorAll('input[data-k], textarea[data-k]').forEach(el=>{
        const k = el.dataset.k;

        el.addEventListener('input', ()=>{
          if (k === 'count') tab.data[k] = Math.max(1, parseInt(el.value||'1', 10));
          else tab.data[k] = el.value;

          if (k === 'customName') {
            const liveDisplay = (tab.data.customName && tab.data.customName.trim()) || tab.data.baseName || 'Monster';
            setTabTitle(tab, liveDisplay, { commit: false });
          }
        });

        el.addEventListener('blur', ()=>{
          if (k === 'customName') {
            const finalDisplay = (tab.data.customName && tab.data.customName.trim()) || tab.data.baseName || 'Monster';
            setTabTitle(tab, finalDisplay, { commit: true });
          }
        });

        if (el.tagName === 'INPUT') {
          el.addEventListener('keydown', (ev)=>{
            if (k === 'customName' && ev.key === 'Enter') { ev.preventDefault(); el.blur(); }
          });
        }
      });

      const themeSel = panel.querySelector('#traitTheme');
      const abilSel  = panel.querySelector('#traitAbility');
      const insertBtn= panel.querySelector('#insertTraitBtn');
      const traitsTA = panel.querySelector('textarea[data-k="traits"]');

      const prevEl   = panel.querySelector('#traitPreview');
      const nameNode = prevEl?.querySelector('.t-name');
      const metaNode = prevEl?.querySelector('.t-meta');
      const effNode  = prevEl?.querySelector('.t-eff');

      function buildThemeOptions() {
        if (!themeSel) return;
        themeSel.innerHTML = '';
        for (const th of TRAIT_THEMES) {
          const list = traitsByTheme.get(th) || [];
          if (!list.length) continue;
          const opt = document.createElement('option');
          opt.value = th;
          opt.textContent = th[0].toUpperCase() + th.slice(1);
          themeSel.appendChild(opt);
        }
      }

      function updatePreview() {
        if (!prevEl || !abilSel) return;
        const opt = abilSel.selectedOptions && abilSel.selectedOptions[0];
        if (!opt) {
          nameNode.textContent = 'Select a theme and ability';
          metaNode.textContent = 'Preview shows here.';
          effNode.textContent  = '—';
          return;
        }
        const t = JSON.parse(opt.dataset.payload || '{}');
        nameNode.textContent = t.name || '(Ability)';
        metaNode.textContent = (t.theme ? t.theme[0].toUpperCase()+t.theme.slice(1) : '').trim();
        effNode.textContent  = t.effect || '';
      }

      function buildAbilityOptions() {
        if (!themeSel || !abilSel) return;
        abilSel.innerHTML = '';
        const list = traitsByTheme.get(themeSel.value) || [];
        for (const t of list) {
          const opt = document.createElement('option');
          const hint = Array.isArray(t.aliases) && t.aliases.length ? ` (${t.aliases[0]}…)` : '';
          opt.value = t.id;
          opt.textContent = t.name + hint;
          opt.dataset.payload = JSON.stringify(t);
          abilSel.appendChild(opt);
        }
        updatePreview(); 
      }

      buildThemeOptions();
      buildAbilityOptions();
      if (themeSel) themeSel.addEventListener('change', ()=>{ buildAbilityOptions(); });
      if (abilSel)  abilSel.addEventListener('change', updatePreview);

      if (insertBtn && abilSel && traitsTA) {
        insertBtn.addEventListener('click', ()=>{
          const opt = abilSel.selectedOptions && abilSel.selectedOptions[0];
          if (!opt) return;
          const t = JSON.parse(opt.dataset.payload || '{}');
          const line = `${t.name}: ${t.effect}`.trim(); 
          const cur  = (traitsTA.value || '').trim();
          traitsTA.value = cur ? (cur + '\n' + line) : line;
          tab.data.traits = traitsTA.value; // keep export in sync
        });
      }

      panel.querySelector('#cloneBtn').addEventListener('click', cloneActive);
      panel.querySelector('#reloadFromPickerBtn').addEventListener('click', ()=>{
        const entry = currentPickerEntry();
        if (!entry) return;
        const prev = tab.data;
        const fresh = toTabDataFromEntry(entry, levelSel.value);
        fresh.customName = prev.customName;
        fresh.count = prev.count;
        tab.data = fresh;

        const base = (tab.data.customName && tab.data.customName.trim()) || tab.data.baseName || 'Monster';
        setTabTitle(tab, base, { commit: true });

        const active = tabs.find(t=>t.id===activeId);
        tabPanel.innerHTML = active ? tabForm(active) : '<div class="card" style="margin:1rem;">No monsters yet.</div>';
        if (active) wireForm(active);
      });
    }

    function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

    function doExport(){
      if (tabs.length === 0) return alert('No monsters to export yet.');
      const wb = XLSX.utils.book_new();

      for (const t of tabs) {
        const d = t.data;
        const traits = (d.traits||'').split(/\r?\n/).filter(Boolean);
        const rows = [
          ['Base Monster', d.baseName],
          ['Name (Optional)', d.customName],
          ['Class', d.class],
          ['Category', d.category],
          ['Subcategory', d.subcategory],
          ['Level', d.level],
          ['Count', d.count],
          ['HP', d.hp],
          ['Image', d.image],
          ['Campaign Links (IDs)', d.campaignLinks],
          ['Description', d.description],
          ['Notes', d.notes],
          [],
          ['Traits'],
          ...traits.map(line => [line])
        ];
        const ws = XLSX.utils.aoa_to_sheet(rows);
        ws['!cols'] = [{ wch: 20 }, { wch: 50 }];

        const sheetTitle = displayNameFor(d);
        const safeTitle = (sheetTitle || 'Monster').slice(0,31);
        XLSX.utils.book_append_sheet(wb, ws, safeTitle || 'Monster');
      }

      const outName = `Monster_Event_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, outName);
    }
  </script>
</body>
</html>
